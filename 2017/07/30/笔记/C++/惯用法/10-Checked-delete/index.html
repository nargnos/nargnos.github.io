<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>[C++ Idioms] 10. Checked delete | {S}</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/6.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.2/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">[C++ Idioms] 10. Checked delete</h1><a id="logo" href="/.">{S}</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> </i></a><a href="/archives/"><i class="fa fa-archive"> </i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">[C++ Idioms] 10. Checked delete</h1><div class="post-meta">2017-07-30<span> | </span><span class="category"><a href="/categories/C-Idioms/">C++ Idioms</a></span></div><div class="post-content"><p>安全的delete对象。<a id="more"></a>  </p>
<p>不安全原因：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Object</span>;</span></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">DestoryObject</span><span class="params">(Object* obj)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">delete</span> obj;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Object</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">	~Object()</div><div class="line">	&#123;</div><div class="line">        <span class="comment">// 此时如果用DestoryObject析构对象，是无法执行到这里的</span></div><div class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"dtor"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>在使用delete之前，如果对象未完整声明，会调用到默认的delete过程而跳过之后声明的析构函数。  </p>
<p>而如果在析构前加了一层模板函数：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Object</span>;</span></div><div class="line"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">Destory</span><span class="params">(T* ptr)</span></span></div><div class="line">&#123;</div><div class="line">	<span class="keyword">delete</span> ptr;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">DestoryObject</span><span class="params">(Object* obj)</span></span></div><div class="line">&#123;</div><div class="line">	Destory(obj);</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Object</span></span></div><div class="line">&#123;</div><div class="line"><span class="keyword">public</span>:</div><div class="line">	~Object()</div><div class="line">	&#123;</div><div class="line">		<span class="built_in">cout</span> &lt;&lt; <span class="string">"dtor"</span> &lt;&lt; <span class="built_in">endl</span>;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>这时候是可以调用到自定义析构的。<br>在智能指针实现里就用到的这个方式。比如STL里的源码：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// TEMPLATE CLASS default_delete</span></div><div class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> _<span class="title">Ty</span>&gt;</span></div><div class="line"><span class="title">struct</span> <span class="title">default_delete</span></div><div class="line">&#123;	<span class="comment">// default deleter for unique_ptr</span></div><div class="line">	<span class="function"><span class="keyword">constexpr</span> <span class="title">default_delete</span><span class="params">()</span> _NOEXCEPT </span>= <span class="keyword">default</span>;</div><div class="line"></div><div class="line">	<span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> _<span class="title">Ty2</span>,</span></div><div class="line">		<span class="title">class</span> = <span class="title">typename</span> <span class="title">enable_if</span>&lt;is_convertible&lt;_Ty2 *, _Ty *&gt;::value,</div><div class="line">		void&gt;::type&gt;</div><div class="line">		default_delete(<span class="keyword">const</span> default_delete&lt;_Ty2&gt;&amp;) _NOEXCEPT</div><div class="line">	&#123;	<span class="comment">// construct from another default_delete</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">void</span> <span class="title">operator</span><span class="params">()</span><span class="params">(_Ty *_Ptr)</span> <span class="keyword">const</span> _NOEXCEPT</span></div><div class="line">	&#123;	<span class="comment">// delete a pointer</span></div><div class="line">		<span class="keyword">static_assert</span>(<span class="number">0</span> &lt; <span class="keyword">sizeof</span>(_Ty),</div><div class="line">			<span class="string">"can't delete an incomplete type"</span>);</div><div class="line">		<span class="keyword">delete</span> _Ptr;</div><div class="line">	&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>此时static_assert是可以通过的，但有时候用智能指针时，后文没有把类型定义完整，还是会无法编译（即使没有自定义析构），因为它用了那句静态断言。sizeof无法获取未定义类型的大小，此时会阻止编译（有些编译器会返回0，这样就会被断言阻断）。而已定义的类型返回总是大于0，所以会通过断言。<br>所以在delete前加上断言检查就可以安全的delete对象。  </p>
<p>在Boost里提供的checked_delete函数就是用来干这事的。<br>不过它阻止编译的方法不是用静态断言，而是用：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt; <span class="title">inline</span> <span class="title">void</span> <span class="title">checked_delete</span>(<span class="title">T</span> * <span class="title">x</span>)</span></div><div class="line">&#123;</div><div class="line">    <span class="comment">// intentionally complex - simplification causes regressions</span></div><div class="line">    <span class="keyword">typedef</span> <span class="keyword">char</span> type_must_be_complete[ <span class="keyword">sizeof</span>(T)? <span class="number">1</span>: <span class="number">-1</span> ];</div><div class="line">    (<span class="keyword">void</span>) <span class="keyword">sizeof</span>(type_must_be_complete);</div><div class="line">    <span class="keyword">delete</span> x;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果sizeof可以求值，那么它在类型未定义时创建一个大小为-1的数组，这个语句会引起编译失败。（可能为了兼容性问题或者历史原因，没有用static_assert，但是新版stl里已经在用了）  </p>
</div><div class="tags"><a href="/tags/C/">C++</a><a href="/tags/Idioms/">Idioms</a><a href="/tags/模板/">模板</a></div><div class="post-nav"><a href="/2017/07/30/笔记/C++/惯用法/11-Clear-and-minimize/" class="pre">[C++ Idioms] 11. [+] Clear and minimize</a><a href="/2017/07/30/笔记/C++/惯用法/9-Capability-Query/" class="next">[C++ Idioms] 9. [-] Capability Query</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="widget-title"><i class="fa fa-bars"></i> 分类</div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/C-Idioms/">C++ Idioms</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/其它/">其它</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-tags"></i> 标签</div><div class="tagcloud"><a href="/tags/C/" style="font-size: 15px;">C++</a> <a href="/tags/Idioms/" style="font-size: 15px;">Idioms</a> <a href="/tags/模板/" style="font-size: 15px;">模板</a></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.0.47/jquery.fancybox.min.css"><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>